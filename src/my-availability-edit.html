<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="short-unique-id.html">

<dom-module id="my-availability-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
            }

            @media (max-width: 768px) {
                paper-checkbox {
                    display: inline-block;
                    padding: 5px;
                    margin-left: 16px;
                }
                #action {
                    margin-top: 10px;
                    float: right;
                }
                .addNotes {
                    float: left;
                    width: 200px;
                }
                #created {
                    display: none;
                }
                .option {
                    margin-top: 40px;
                }
                #Notes {
                    display: none;
                }
            }

            @media (min-width: 768px) {
                paper-checkbox {
                    display: inline-block;
                    padding: 5px;
                    margin-left: 16px auto;
                }
                #icon_notes {
                    display: block;
                }
                .addNotes {
                    float: left;
                    cursor: pointer;
                    margin-left: 10px;
                    width: 300px;
                }
                .hotelSearch {
                    margin-left: -25px;
                }
            }

            #hotels {
                font-size: small;
                /* font-family: "Trebuchet MS", Arial, Helvetica, sans-serif; */
                border-collapse: collapse;
                width: 100%;
            }

            #hotels td,
            #hotels th {
                text-align: center;
                border: 1px solid #ddd;
                /* padding: 2px; */
            }

            #hotels th {
                padding-top: 12px;
                padding-bottom: 12px;
            }

            paper-fab.blue {
                position: fixed;
                bottom: 32px;
                right: 32px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: darkorange;
            }

            #action {
                margin-top: 10px;
                float: right;
            }

            .red {
                background: red;
                color: white;
            }

            .yellow {
                background: yellow;
                color: white;
            }

            .green {
                background: green;
                color: black;
            }

            hr {
                background-color: rgb(238, 238, 238);
                border: 0 none;
                color: #eee;
                height: 1px;
            }

            .card {
                font-size: small;
            }

            #month {
                font-weight: bold;
            }

            #table {
                padding-bottom: 16px;
                opacity: 1;
                animation-name: fadeInOpacity;
                animation-iteration-count: 1;
                animation-timing-function: ease-in;
                animation-duration: 0.5s;
            }
        </style>
        <custom-style>
            <style is="custom-style">
                paper-fab.blue {
                    /* --paper-fab-background: var(--paper-indigo-500); */
                    --paper-fab-background: darkorange;
                    --paper-fab-keyboard-focus-background: darkorange;
                }

                paper-checkbox {
                    --paper-checkbox-label-spacing: 5px;
                }

                paper-checkbox.close {
                    --paper-checkbox-unchecked-color: red;
                    --paper-checkbox-checked-color: red;
                    --paper-checkbox-label-color: red
                }

                paper-checkbox.limited {
                    --paper-checkbox-unchecked-color: yellow;
                    --paper-checkbox-checked-color: yellow;
                    --paper-checkbox-label-color: yellow
                }

                paper-checkbox.available {
                    --paper-checkbox-unchecked-color: green;
                    --paper-checkbox-checked-color: green;
                    --paper-checkbox-label-color: green
                }
            </style>
        </custom-style>
        <iron-ajax auto url="{{url}}" params='{}' handle-as="json" on-response="_availabilityLoaded" loading="{{loadingData}}" debounce-duration="300"></iron-ajax>
        <iron-ajax auto url="{{urlalloc}}" params='{}' handle-as="json" on-response="_allocLoaded" loading="{{loadingData}}" debounce-duration="300"></iron-ajax>
        <iron-ajax auto url="{{urluser}}" params='{}' handle-as="json" on-response="_userLoaded"></iron-ajax>
        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-header-layout id="appheader" has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar>
                        <a href="/availability">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                        </a>
                        <div main-title>Edit Availability</div>
                        <!-- <paper-icon-button class="menu" icon="my-icons:delete-forever" on-tap="_openDelete"></paper-icon-button> -->
                    </app-toolbar>
                </app-header>
                <div class="card">
                    <div class="hotels" style="padding:26px; margin-top:-30px; margin-bottom:56px; ">
                        <div class="hotelSearch">
                            <div style="float:left;">
                                <div style="display:flex;">
                                    <paper-input always-float-label label="Hotel" value="{{hotelname}}" readonly style="width: 160px;">
                                        <iron-icon icon="my-icons:location-city" slot="prefix"></iron-icon>
                                    </paper-input>
                                </div>
                            </div>
                        </div>
                        <div class="addNotes" id="notes">
                            <paper-input always-float-label label="Notes" value="{{mynotes}}">
                                <iron-icon icon="my-icons:speaker-notes" slot="prefix"></iron-icon>
                            </paper-input>
                        </div>
                    </div>
                    <div class="option">
                        <hr>
                        <paper-checkbox class="close" on-tap="_close" id="close">Close</paper-checkbox>
                        <paper-checkbox class="limited" on-tap="_limited" id="limited">Limited</paper-checkbox>
                        <paper-checkbox class="available" on-tap="_available" id="available">Open</paper-checkbox>
                        <span id="month" style="margin-top: 10px; float: right">
                            <paper-icon-button id="previous" noink on-tap="_preMonth" style="color: black;" icon="my-icons:keyboard-arrow-left"></paper-icon-button>
                            {{month}}
                            <paper-icon-button id="next" noink on-tap="_nextMonth" style="color: black;" icon="my-icons:keyboard-arrow-right"></paper-icon-button>
                        </span>
                    </div>
                    <div id="table">
                        <table id="hotels">
                        </table>
                    </div>
                    <div>
                        <iron-icon icon="my-icons:flag" slot="prefix"></iron-icon>
                        <span id="created">Created by:</span> {{created_by}}&nbsp;
                        <time-ago datetime$="{{_timeStampToDateTime(createdAt)}}">{{_timeStampToDateTime(createdAt)}}</time-ago>
                    </div>
                    <div>
                        <iron-icon icon="my-icons:update" slot="prefix"></iron-icon>
                        <span id="created">Last Modified by:</span>{{updated_by}}&nbsp;
                        <time-ago datetime$="{{_timeStampToDateTime(updatedAt)}}">{{_timeStampToDateTime(updatedAt)}}</time-ago>
                    </div>
                </div>
            </app-header-layout>
            </app-header-layout>
            <!-- _openSave -->
            <paper-fab noink on-tap="_saveToDB" icon="my-icons:save" class="blue" id="save"></paper-fab>
            <vaadin-dialog id="availabilitySave" no-close-on-esc no-close-on-outside-click>
                <template>
                    <h3 style="text-align: center">Save changes for month of {{updateDate}}?</h3>
                    <hr>
                    <span style="float: right">
                        <paper-button on-tap="_update">Yes</paper-button>
                        <paper-button on-tap="_closeDialog">No</paper-button>
                    </span>
                </template>
            </vaadin-dialog>
            <vaadin-dialog id="availabilityDelete" no-close-on-esc no-close-on-outside-click>
                <template>
                    <h3 style="text-align: center">Are you sure to delete "{{hotelname}}"
                        <br> availability records permanently?
                        <br>there will be no undo</h3>
                    <hr>
                    <span style="float: right">
                        <paper-button on-tap="_delete" style="color: red">Yes</paper-button>
                        <paper-button on-tap="_closeDialog">No</paper-button>
                    </span>
                </template>
            </vaadin-dialog>
            <vaadin-dialog id="successModal" no-close-on-esc no-close-on-outside-click>
                <template>
                    <h3 style="text-align: center">Deleted Successfully</h3>
                    <hr>
                    <a href="/availability">
                        <paper-button on-tap="_back" style="float: right;text-decoration: none">Ok</paper-button>
                    </a>
                </template>
            </vaadin-dialog>
            <vaadin-dialog id="successUpdate" no-close-on-esc no-close-on-outside-click>
                <template>
                    <h3 style="text-align: center">Updated Successfully</h3>
                    <hr>
                    <a href="/availability">
                        <paper-button on-tap="_closeModal" style="float: right">Ok</paper-button>
                    </a>
                </template>
            </vaadin-dialog>
            <paper-dialog id="saveNext">
                <h3 style="text-align: center">Save changes for month of {{updateDate}}?</h3>
                <hr>
                <span style="float: right">
                    <paper-button on-tap="_saveToDB" auto-focus>Yes</paper-button>
                    <paper-button on-tap="_closeDialog">No</paper-button>
                </span>
            </paper-dialog>
            </div>
        </app-drawer-layout>
        <iron-ajax verbose id="ajax" method="[[method]]" on-response="_handleResponse"></iron-ajax>
        <iron-ajax verbose id="ajax2" method="[[method]]" on-response="_handleResponse2"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'my-availability-edit',
            properties: {
                editKey: { type: String, notify: true, observer: '_onkeyChanged' },
                route: Object,
                mynotes: String,
                hotelname: String,
                mot: Number,
                yer: Number,
                yearly: String,
                monthly: String,
                editId: String,
                accountKey: String,
                date: String,
                nextmonth: String,
                previousmonth: String,
                prevmonth: String,
                prevyear: String,
                updateDate: String,
                newmont: String,
                availabilityItem: {
                    type: Array,
                    notify: true,
                    // value: [],
                },
                initialAvail: {
                    type: Array,
                    notify: true,
                    value: []
                },
                availabilities: {
                    type: Array,
                    notify: true,
                    value: []
                },
                roomType: {
                    type: Array,
                    notify: true,
                    value: [],
                },
                type: {
                    type: Array,
                    value: [],
                },
                roomData: {
                    type: Array,
                    value: [],
                    notify: true,
                },
                saveDate: {
                    type: Array,
                    notify: true,
                    value: []
                },
                monthArray: {
                    type: Array,
                    notify: true,
                    value: []
                },
                monthyrArray: {
                    type: Array,
                    notify: true,
                    value: []
                },
                availArray: {
                    type: Array,
                    notify: true,
                    value: []
                },
                saveDate: {
                    type: Array,
                    notify: true,
                    value: []
                },
                availId: {
                    type: Array,
                    notify: true,
                    value: []
                },
            },
            ready() {
                this.monthyrArray = [];
                this.availArray = [];
                this.monthArray = [];
                this.saveDate = [];
                this.availId = [];
            },
            _openSave() {
                this.$.availabilitySave.opened = true;
            },
            _openDelete() {
                this.$.availabilityDelete.opened = true;
            },
            _closeDialog() {
                this.$.availabilitySave.opened = false;
                this.$.availabilityDelete.opened = false;
            },
            _closeModal() {
                this.$.successModal.opened = false;
                this.$.successUpdate.opened = false;
                this.monthyrArray = [];
                this.availArray = [];
                this.monthArray = [];
                this.saveDate = [];
                this.availId = [];
            },
            _back() {
                this.$.successModal.opened = false;
                this.$.successUpdate.opened = false;
                // window.location.assign('/availability');
            },
            _delete() {
                if (this.hotel) {
                    this.method = 'DELETE';
                    this.$.ajax.url = '/availability/delete/' + this.hotel;
                    this.$.ajax.generateRequest();
                    this.url = '/availability/dummy';
                    this.$.availabilityDelete.opened = false;
                    this.$.successModal.opened = true;
                }
            },
            _available() {
                var showsave = Polymer.dom(this.root).querySelector("#save");
                var next = Polymer.dom(this.root).querySelector("#next");
                var prev = Polymer.dom(this.root).querySelector("#previous");
                var notes = Polymer.dom(this.root).querySelector("#notes");
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;

                var isMouseDownavail = false;

                for (var i = 0; i < cells.length; i++) {
                    cells[i].onmousedown = function (event) {
                        if (event.target.id != "") {
                            isMouseDownavail = true;
                            this.className = this.className === '' || this.className === "white" ? "green" : "white";
                            var [room, roomname, date] = event.target.id.split("_");
                            if (this.className == 'green') {
                                var classColor = event.target.getAttribute("class");
                                // next.disabled = true;
                                // prev.disabled = true;
                                next.disabled = false;
                                prev.disabled = false;
                                showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                notes.setAttribute("style", "display:block");
                                var data = {
                                    date: date,
                                    room: room,
                                    roomname: roomname,
                                    classColor: classColor,
                                    status: 'open'
                                }
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities[i].status = "open";
                                            _this.availabilities[i].classColor = "green";
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (i === _this.availabilities.length) {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                } else {
                                    _this.availabilities.push(data);
                                    _this.notifySplices('availabilities');
                                }
                            }
                            else {
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities.splice(i, 1);
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (_this.availabilities.length === 0) {
                                        next.disabled = false;
                                        prev.disabled = false;
                                        showsave.setAttribute("style", "display:none;");
                                        notes.setAttribute("style", "display:none");
                                    }
                                }
                            }
                        }

                    }
                    cells[i].onmouseover = function (event) {
                        if (event.target.id != "") {
                            if (isMouseDownavail) {
                                this.className = this.className === '' || this.className === "white" ? "green" : "white";
                                var [room, roomname, date] = event.target.id.split("_");
                                if (this.className == 'green') {
                                    var classColor = event.target.getAttribute("class");
                                    // next.disabled = true;
                                    // prev.disabled = true;
                                    next.disabled = false;
                                    prev.disabled = false;
                                    showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                    notes.setAttribute("style", "display:block");
                                    var data = {
                                        date: date,
                                        room: room,
                                        roomname: roomname,
                                        classColor: classColor,
                                        status: 'open'
                                    }
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities[i].status = "open";
                                                _this.availabilities[i].classColor = "green";
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (i === _this.availabilities.length) {
                                            _this.availabilities.push(data);
                                            _this.notifySplices('availabilities');
                                        }
                                    } else {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                }
                                else {
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities.splice(i, 1);
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (_this.availabilities.length === 0) {
                                            next.disabled = false;
                                            prev.disabled = false;
                                            showsave.setAttribute("style", "display:none;");
                                            notes.setAttribute("style", "display:none");
                                        }
                                    }
                                }
                            }
                        }

                    }
                    cells[i].onmouseup = function (event) {
                        isMouseDownavail = false;
                    }
                }
            },
            _limited() {
                var showsave = Polymer.dom(this.root).querySelector("#save");
                var next = Polymer.dom(this.root).querySelector("#next");
                var prev = Polymer.dom(this.root).querySelector("#previous");
                var notes = Polymer.dom(this.root).querySelector("#notes");
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;
                var isMouseDownlimit = false;

                for (var i = 0; i < cells.length; i++) {
                    cells[i].onmousedown = function (event) {
                        if (event.target.id != "") {
                            isMouseDownlimit = true;
                            this.className = this.className === '' || this.className === "white" ? "yellow" : "white";
                            var [room, roomname, date] = event.target.id.split("_");
                            if (this.className == 'yellow') {
                                var classColor = event.target.getAttribute("class");
                                // next.disabled = true;
                                // prev.disabled = true;
                                next.disabled = false;
                                prev.disabled = false;
                                showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                notes.setAttribute("style", "display:block");
                                var data = {
                                    date: date,
                                    room: room,
                                    roomname: roomname,
                                    classColor: classColor,
                                    status: 'limited'
                                }
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities[i].status = "limited";
                                            _this.availabilities[i].classColor = "yellow";
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (i === _this.availabilities.length) {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                } else {
                                    _this.availabilities.push(data);
                                    _this.notifySplices('availabilities');
                                }
                            }
                            else {
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities.splice(i, 1);
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (_this.availabilities.length === 0) {
                                        next.disabled = false;
                                        prev.disabled = false;
                                        showsave.setAttribute("style", "display:none;");
                                        notes.setAttribute("style", "display:none");
                                    }
                                }
                            }
                        }
                    }
                    cells[i].onmouseover = function (event) {
                        if (event.target.id != "") {
                            if (isMouseDownlimit) {
                                this.className = this.className === '' || this.className === "white" ? "yellow" : "white";
                                var [room, roomname, date] = event.target.id.split("_");
                                if (this.className == 'yellow') {
                                    var classColor = event.target.getAttribute("class");
                                    // next.disabled = true;
                                    // prev.disabled = true;
                                    next.disabled = false;
                                    prev.disabled = false;
                                    showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                    notes.setAttribute("style", "display:block");
                                    var data = {
                                        date: date,
                                        room: room,
                                        roomname: roomname,
                                        classColor: classColor,
                                        status: 'limited'
                                    }
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities[i].status = "limited";
                                                _this.availabilities[i].classColor = "yellow";
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (i === _this.availabilities.length) {
                                            _this.availabilities.push(data);
                                            _this.notifySplices('availabilities');
                                        }
                                    } else {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                }
                                else {
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities.splice(i, 1);
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (_this.availabilities.length === 0) {
                                            next.disabled = false;
                                            prev.disabled = false;
                                            showsave.setAttribute("style", "display:none;");
                                            notes.setAttribute("style", "display:none");
                                        }
                                    }
                                }
                            }
                        }
                    }
                    cells[i].onmouseup = function (event) {
                        isMouseDownlimit = false;
                    }

                }
            },
            _close() {
                var showsave = Polymer.dom(this.root).querySelector("#save");
                var next = Polymer.dom(this.root).querySelector("#next");
                var prev = Polymer.dom(this.root).querySelector("#previous");
                var notes = Polymer.dom(this.root).querySelector("#notes");
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;
                var isMouseDownclose = false;

                for (var i = 0; i < cells.length; i++) {
                    cells[i].onmousedown = function (event) {
                        if (event.target.id != "") {
                            isMouseDownclose = true;
                            this.className = this.className === '' || this.className === "white" ? "red" : "white";
                            var [room, roomname, date] = event.target.id.split("_");
                            if (this.className == 'red') {
                                var classColor = event.target.getAttribute("class");
                                // next.disabled = true;
                                // prev.disabled = true;
                                next.disabled = false;
                                prev.disabled = false;
                                showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                notes.setAttribute("style", "display:block");
                                var data = {
                                    date: date,
                                    room: room,
                                    roomname: roomname,
                                    classColor: classColor,
                                    status: 'closed'
                                }
                                // console.log(data);
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities[i].status = "closed";
                                            _this.availabilities[i].classColor = "red";
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (i === _this.availabilities.length) {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                }
                                else {
                                    _this.availabilities.push(data);
                                    _this.notifySplices('availabilities');
                                }
                            }
                            else {
                                if (_this.availabilities.length > 0) {
                                    for (var i = 0; i < _this.availabilities.length; i++) {
                                        if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                            _this.availabilities.splice(i, 1);
                                            _this.notifySplices('availabilities');
                                            break;
                                        }
                                    }
                                    if (_this.availabilities.length === 0) {
                                        next.disabled = false;
                                        prev.disabled = false;
                                        showsave.setAttribute("style", "display:none;");
                                        notes.setAttribute("style", "display:none");
                                    }
                                }
                            }
                        }
                    }
                    cells[i].onmouseover = function (event) {
                        if (event.target.id != "") {
                            if (isMouseDownclose) {
                                this.className = this.className === '' || this.className === "white" ? "red" : "white";
                                var [room, roomname, date] = event.target.id.split("_");
                                if (this.className == 'red') {
                                    var classColor = event.target.getAttribute("class");
                                    // next.disabled = true;
                                    // prev.disabled = true;
                                    next.disabled = false;
                                    prev.disabled = false;
                                    showsave.setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                                    notes.setAttribute("style", "display:block");
                                    var data = {
                                        date: date,
                                        room: room,
                                        roomname: roomname,
                                        classColor: classColor,
                                        status: 'closed'
                                    }
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities[i].status = "closed";
                                                _this.availabilities[i].classColor = "red";
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (i === _this.availabilities.length) {
                                            _this.availabilities.push(data);
                                            _this.notifySplices('availabilities');
                                        }
                                    }
                                    else {
                                        _this.availabilities.push(data);
                                        _this.notifySplices('availabilities');
                                    }
                                }
                                else {
                                    if (_this.availabilities.length > 0) {
                                        for (var i = 0; i < _this.availabilities.length; i++) {
                                            if (date == _this.availabilities[i].date && room == _this.availabilities[i].room) {
                                                _this.availabilities.splice(i, 1);
                                                _this.notifySplices('availabilities');
                                                break;
                                            }
                                        }
                                        if (_this.availabilities.length === 0) {
                                            next.disabled = false;
                                            prev.disabled = false;
                                            showsave.setAttribute("style", "display:none;");
                                            notes.setAttribute("style", "display:none");
                                        }
                                    }
                                }
                            }
                        }
                    }
                    cells[i].onmouseup = function (event) {
                        isMouseDownclose = false;
                    }
                }
            },
            _saveToDB() {
                this.availId.push(this.editId);
                var dateSaved = { date: this.datehandle };
                this.saveDate.push(dateSaved);
                var monthyear = [this.mot + "," + this.yer];
                var combine = {
                    my: monthyear,
                    data: this.availabilities
                };
                this.availArray.push(combine);
                if (this.hotel) {
                    for (var i = 0; i < this.monthyrArray.length; i++) {
                        if (this.availId[i] != null && this.saveDate[i].date == this.monthyrArray[i]) {
                            var types = [];
                            this.roomType.forEach(element => {
                                types.push(element);
                            });
                            this.method = 'PUT';
                            this.$.ajax2.url = '/availability/update/' + this.availId[i];
                            this.$.ajax2.contentType = "application/json";
                            this.$.ajax2.body = {
                                hotel: this.hotel,
                                hotelname: this.hotelname,
                                notes: this.mynotes,
                                availabilities: this.availArray[i].data,
                                date: this.monthyrArray[i],
                                type: types,
                                month: {
                                    month: this.monthArray[i].mnt,
                                    yearly: this.monthArray[i].yr,
                                },
                                created_by: this.created_by,
                                updated_by: this.modifiedBy,
                            };
                            this.$.ajax2.generateRequest();
                        }
                        if (this.availId[i] == null) {
                            var types = [];
                            this.roomType.forEach(element => {
                                types.push(element);
                            });
                            this.method = 'POST';
                            this.$.ajax2.url = '/availability/add';
                            this.$.ajax2.contentType = "application/json";
                            this.$.ajax2.body = {
                                hotel: this.hotel,
                                hotelname: this.hotelname,
                                notes: this.mynotes,
                                availabilities: this.availArray[i].data,
                                date: this.monthyrArray[i],
                                type: types,
                                month: {
                                    month: this.monthArray[i].mnt,
                                    yearly: this.monthArray[i].yr,
                                },
                                created_by: this.created_by,
                                updated_by: this.modifiedBy,
                            };
                            this.$.ajax2.generateRequest();
                        }
                    }
                    this.$.availabilitySave.opened = false;
                    this.$.successUpdate.opened = true; //e
                }

                Polymer.dom(this.root).querySelector("#next").disabled = false;
                Polymer.dom(this.root).querySelector("#previous").disabled = false;
            },
            _update() {
                this._saveToDB(true);
            },
            _availabilityLoaded(data) {
                if (data.detail.response.data) {
                    if (this.editKey) {
                        if (this.url === '/availability/readEdit/' + this.editKey) {
                            this.hotel = data.detail.response.data.hotel;
                            this.hotelname = data.detail.response.data.hotelname;
                            this.date = data.detail.response.data.date;
                            // this.saveDate = this.date;
                            this.monthly = data.detail.response.data.month.month;
                            this.yearly = data.detail.response.data.month.yearly;
                            this.mynotes = data.detail.response.data.notes;
                            this.mynotes = this.mynotes;
                            this.createdAt = data.detail.response.data.createdAt;
                            this.updatedAt = data.detail.response.data.updatedAt;
                            this.created_by = data.detail.response.data.created_by;
                            // this.updated_by = data.detail.response.data.updated_by;
                            var data1 = data.detail.response.data.availability;
                            this.roomType = data.detail.response.data.type;
                            var year = parseInt(this.yearly);
                            var month = parseInt(this.monthly);
                            var currentMonthly = new Date(year, month);
                            var months = currentMonthly.getMonth();
                            var years = currentMonthly.getFullYear();
                            var dayToday = currentMonthly.getDay();
                            var daynow = this._selectDays(dayToday);
                            var mon = this._selectMonth(months);
                            this.mot = months;
                            this.yer = years;
                            this.month = mon + " " + years;
                            var date = new Date(years, months + 1, 0).getDate();
                            this.availabilities = data1;
                            this._createTable(date, mon, years, months, data1);
                            this.urlalloc = 'allocation/filter/' + this.hotel;
                        }

                        var monthyr = {
                            mnt: this.mot,
                            yr: this.yer
                        };
                        this.monthArray.push(monthyr);
                        var monthyear = [this.mot + "," + this.yer];
                        this.monthyrArray.push(monthyear);
                        this.method = 'GET';
                        this.$.ajax.url = '/availability/filter/' + this.hotel + "~" + this.mot + "~" + this.yer;
                        this.$.ajax.handleAs = "json";
                        this.$.ajax.generateRequest();
                    }
                }
                this.method = 'GET';
                this.urluser = '/user/getkey/' + this.accountKey;
                this.$.ajax.handleAs = "json";
                this.$.ajax.generateRequest();
            },
            _handleResponse2() { },
            _handleResponse(data) {
                if (data.detail.response) {
                    var availability = [];
                    var datas = data.detail.response.data;

                    datas.forEach(element => {
                        this.editId = element._id;
                        this.datehandle = element.date;
                        this.availabilityItem = element.availability;
                        var monthnow = element.month.month;
                        // this.mynotes = element.notes;
                        this.mynotes = this.mynotes;
                        var yeartoday = element.month.yearly;
                        var year = parseInt(yeartoday);
                        var month = parseInt(monthnow);
                        var currentMonthly = new Date(year, month);
                        var months = currentMonthly.getMonth();
                        var years = currentMonthly.getFullYear();
                        var dayToday = currentMonthly.getDay();
                        var daynow = this._selectDays(dayToday);
                        var mon = this._selectMonth(months);
                        this.mot = months;
                        this.yer = years;
                        this.month = mon + " " + years;
                        element.availability.forEach(el => {
                            availability.push(el);
                        })
                    });
                }
                var mon = this._selectMonth(this.mot);
                var date = new Date(this.yer, this.mot + 1, 0).getDate();
                // this._createTable(date, mon, this.yer, this.mot, availability);
                // this.availabilities = availability;
                for (var i = 0; i < this.availArray.length; i++) {
                    if (this.availArray[i].my.toString() === this.xyzab) {
                        this._createTable(date, mon, this.yer, this.mot, this.availArray[i].data);
                        this.availabilities = this.availArray[i].data;
                        break;
                    }
                    else {
                        this._createTable(date, mon, this.yer, this.mot, availability);
                        this.availabilities = availability;
                    }
                }
                if (this.availabilities.length > 0) {
                    Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                    Polymer.dom(this.root).querySelector("#notes").setAttribute("style", "display:block");
                } else {
                    Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:none");
                    Polymer.dom(this.root).querySelector("#notes").setAttribute("style", "display:none");
                    this.datehandle = null;
                    this.editId = null;
                }
            },
            _allocLoaded(data) {
                if (data.detail.response.data) {
                    this.roomData = data.detail.response.data.rooms;
                    this.notifyPath("roomData", data.detail.response.data.rooms);
                }
            },
            _preMonth() {
                var xyz = [this.mot + "," + this.yer];
                if (this.mot < 1) {
                    var x = 11;
                    var y = this.yer - 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.yer = y;
                    this.month = m + " " + y;
                    var date = new Date(y, x + 1, 0).getDate();
                    this._createTable(date, this.mot, y, x)
                }
                else {
                    var y = this.yer;
                    var x = this.mot - 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.month = m + " " + this.yer;
                    var date = new Date(this.yer, x + 1, 0).getDate();
                    this._createTable(date, this.mot, this.yer, x)
                }

                this.availId.push(this.editId);

                var monthyr = {
                    mnt: this.mot,
                    yr: this.yer
                };

                this.monthArray.push(monthyr);
                var monthyear = [this.mot + "," + this.yer];
                this.xyzab = this.mot + "," + this.yer;
                this.monthyrArray.push(monthyear);
                var combine = {
                    my: xyz,
                    data: this.availabilities
                };
                this.availArray.push(combine);
                var dateSaved = { date: this.datehandle };
                this.saveDate.push(dateSaved);

                this.prevmonth = this.mot;
                this.prevyear = y;
                this.method = 'GET';
                this.$.ajax.url = '/availability/filter/' + this.hotel + "~" + this.mot + "~" + this.yer;
                this.$.ajax.handleAs = "json";
                this.$.ajax.generateRequest();

                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;

            },
            _nextMonth() {
                var xyz = [this.mot + "," + this.yer];
                if (this.mot > 10) {
                    var x = 0;
                    var y = this.yer + 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.yer = y;
                    this.month = m + " " + y;
                    var date = new Date(y, x + 1, 0).getDate();
                    this._createTable(date, this.mot, y, x)
                }
                else {
                    var y = this.yer;
                    var x = this.mot + 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.month = m + " " + this.yer;
                    var date = new Date(this.yer, x + 1, 0).getDate();
                    this._createTable(date, this.mot, this.yer, x)
                }
                this.availId.push(this.editId);

                var monthyr = {
                    mnt: this.mot,
                    yr: this.yer
                };

                this.monthArray.push(monthyr);
                var monthyear = [this.mot + "," + this.yer];
                this.xyzab = this.mot + "," + this.yer;
                this.monthyrArray.push(monthyear);
                var combine = {
                    my: xyz,
                    data: this.availabilities
                };
                this.availArray.push(combine);
                var dateSaved = { date: this.datehandle };
                this.saveDate.push(dateSaved);

                this.nextmonth = this.date;
                this.prevmonth = this.mot;
                this.prevyear = y;
                this.method = 'GET';
                this.$.ajax.url = '/availability/filter/' + this.hotel + "~" + this.mot + "~" + this.yer;
                this.$.ajax.handleAs = "json";
                this.$.ajax.generateRequest();

                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
            },
            _createTable(numDays, months, years, daysWeek, data) {
                var table = Polymer.dom(this.root).querySelector('#hotels');
                while (table.hasChildNodes()) {
                    table.removeChild(table.lastChild);
                }
                table.setAttribute("style", "table-layout: fixed;");
                //for months date
                this.updateDate = months;
                var dailyMonth = this._selectMonth(this.mot);
                var tr1 = document.createElement('tr');
                var th1 = document.createElement('th');
                var t1 = document.createTextNode(dailyMonth + " " + years);
                th1.setAttribute("style", "width:50px;");
                th1.append(t1);
                tr1.append(th1);
                table.append(tr1);
                //for weeks name
                var tr2 = document.createElement('tr');
                var th2 = document.createElement('td');
                var t2 = document.createTextNode("Rooms");
                th2.append(t2);
                tr2.append(th2);
                table.append(tr2);
                this.roomType.forEach(element => {
                    var tr3 = document.createElement('tr');
                    var th3 = document.createElement('td');
                    var dataroom = element.room.split(" ").join("");
                    var datas = element.roomname.split(" ").join("");
                    var tdTxt = document.createTextNode(datas);
                    th3.setAttribute("style", "text-align:left");
                    tr3.setAttribute('id', element.room);
                    th3.append(tdTxt);
                    tr3.append(th3);
                    table.append(tr3);
                    for (i = 1; i < numDays + 1; ++i) {
                        var tdBlank = document.createElement('td');
                        // var dates = months + 1;
                        if (daysWeek < 10 && i < 10) {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + "0" + this.mot + "-" + "0" + i);
                            tr3.append(tdBlank);
                        } else if (daysWeek == 10 && i == 10) {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + this.mot + "-" + i);
                            tr3.append(tdBlank);
                        } else if (daysWeek < 10 && i >= 10) {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + "0" + this.mot + "-" + i);
                            tr3.append(tdBlank);
                        } else if (daysWeek >= 10 && i < 10) {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + this.mot + "-" + "0" + i);
                            tr3.append(tdBlank);
                        } else if (daysWeek >= 10 && i >= 10) {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + this.mot + "-" + i);
                            tr3.append(tdBlank);
                        } else {
                            tdBlank.setAttribute('id', dataroom + "_" + datas + "_" + years + "-" + this.mot + "-" + i);
                            tr3.append(tdBlank);
                            // console.log(tdBlank);
                        }
                    }
                });
                for (i = 1; i < numDays + 1; ++i) {
                    var th = document.createElement('th');
                    var td = document.createTextNode(i);
                    th.setAttribute("style", "width:5px;");
                    th.append(td);
                    tr1.append(th);
                    //weeks
                    var thweek = document.createElement('td');
                    var date = new Date(years, daysWeek, i)
                    var x = date.getDay();
                    var now = this._selectDays(x);
                    if (now == "Sun") {
                        var tdays = document.createTextNode(now);
                        thweek.setAttribute("style", "color:red;font-size:x-small;");
                        thweek.append(tdays);
                        tr2.append(thweek);
                    }
                    else {
                        var tdays = document.createTextNode(now);
                        thweek.append(tdays);
                        thweek.setAttribute("style", "font-size:x-small;");
                        tr2.append(thweek);
                    }
                }
                if (!data) {
                }
                else {
                    data.forEach(element => {
                        var roomdata = element.room.split(" ").join("");
                        var roomname = element.roomname.split(" ").join("");
                        var tr = Polymer.dom(this.root).querySelector("#" + roomdata);
                        var id = roomdata + "_" + roomname + "_" + element.date;
                        // console.log(id);
                        var cells = Polymer.dom(this.root).querySelector("#" + id);
                        cells.setAttribute('class', element.classColor);
                    });
                }
            },
            _selectMonth(e) {
                var nextmonthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                return nextmonthNames[e];
            },
            _selectDays(g) {
                var weekOfdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                return weekOfdays[g];
            },
            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },
            _onkeyChanged() {
                if (this.editKey) {
                    this.url = '/availability/readEdit/' + this.editKey;
                } else {
                    this.url = '/availability/dummy';
                }
            },
            _userLoaded(data) {
                if (data.detail.response.data) {
                    this.modifiedBy = data.detail.response.data.name;
                }
            },
            _timeStampToDateTime(ts) {
                return new Date(ts);
            },
        })  
    </script>
</dom-module>