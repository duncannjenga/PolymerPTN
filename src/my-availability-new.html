<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-input/paper-dropdown-input.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="short-unique-id.html">
<script src="../bower_components/moment/moment.js"></script>
<dom-module id="my-availability-new">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            #table {
                opacity: 1;
                animation-name: fadeInOpacity;
                animation-iteration-count: 1;
                animation-timing-function: ease-in;
                animation-duration: 0.5s;
            }

            @keyframes fadeInOpacity {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }

            @media (max-width: 768px) {
                paper-checkbox {
                    display: inline-block;
                    padding: 5px;
                    margin-left: 16px;
                }
                #action {
                    margin-top: 10px;
                    float: right;
                }
                #Notes {
                    display: none;
                }
                .addNotes {
                    float: left;
                    width: 200px;
                }
                #created {
                    display: none;
                }
                /* .option {
                    margin-top: 40px;
                } */
            }

            @media (min-width: 768px) {
                paper-checkbox {
                    display: inline-block;
                    padding: 5px;
                    margin-left: 16px auto;
                }
                #icon_notes {
                    display: none;
                }
                .addNotes {
                    float: right;
                    cursor: pointer;
                    margin-right: -15px;
                    width: 300px;
                }
                .hotelSearch {
                    margin-left: -5px;
                }
            }

            #hotels {
                font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
                border-collapse: collapse;
                width: 100%;
            }

            #hotels td,
            #hotels th {
                text-align: center;
                border: 1px solid #ddd;
                padding: 2px;

            }

            #hotels th {
                padding-top: 12px;
                padding-bottom: 12px;
            }

            paper-fab.blue {
                position: fixed;
                bottom: 32px;
                right: 32px;

            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: darkorange;
            }

            paper-dialog#openNewNotes {
                border-color: #4caf50;
                background-color: #f1f8e9;
            }

            paper-dialog#availabilitySave {
                border-color: #4caf50;
                background-color: #f1f8e9;
            }

            #action {
                margin-top: 10px;
                float: right;
            }

            .red {
                background: red;
                color: white;
            }

            .yellow {
                background: yellow;
                color: white;
            }

            .green {
                background: green;
                color: black;
            }

            hr {
                background-color: #eee;
                border: 0 none;
                color: #eee;
                height: 1px;
            }
        </style>
        <custom-style>
            <style is="custom-style">
                paper-fab.blue {
                    /* --paper-fab-background: var(--paper-indigo-500); */
                    --paper-fab-background: darkorange;
                    --paper-fab-keyboard-focus-background: darkorange;
                }

                paper-checkbox {
                    --paper-checkbox-label-spacing: 5px;
                }

                paper-checkbox.close {
                    --paper-checkbox-unchecked-color: red;
                    --paper-checkbox-checked-color: red;
                    --paper-checkbox-label-color: red
                }

                paper-checkbox.limited {
                    --paper-checkbox-unchecked-color: yellow;
                    --paper-checkbox-checked-color: yellow;
                    --paper-checkbox-label-color: yellow
                }

                paper-checkbox.available {
                    --paper-checkbox-unchecked-color: green;
                    --paper-checkbox-checked-color: green;
                    --paper-checkbox-label-color: green
                }
            </style>
        </custom-style>
        <iron-ajax auto url="{{url}}" params='{}' handle-as="json" on-response="_hotelLoaded" loading="{{loadingData}}" debounce-duration="300"></iron-ajax>
        <iron-ajax auto url="{{availabilityurl}}" params='{}' handle-as="json" on-response="_availabilityLoaded" loading="{{loadingData}}"
            debounce-duration="300"></iron-ajax>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-header-layout id="appheader" has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar>
                        <a href="/availability">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                        </a>
                        <div main-title>Add Availability</div>
                    </app-toolbar>
                </app-header>
                <div class="card">
                    <div>
                        <iron-icon icon="my-icons:flag" slot="prefix"></iron-icon>
                        <span id="created">Created by:</span> {{createdBy}}
                    </div>
                    <div class="hotels" style="padding:26px; margin-top:-30px; margin-bottom:56px; ">
                        <div class="hotelSearch">
                            <div style="float:left;">
                                <div style="display:flex;">
                                    <paper-dropdown-input label="Filter Hotel" items='[[hotelItems]]' filter-property="hotel" value="{{hotelId}}">
                                        <template>
                                            <template is="dom-repeat" items="[[items]]" as="item">
                                                <paper-item>[[item.hotel]]</paper-item>
                                            </template>
                                        </template>
                                    </paper-dropdown-input>
                                </div>
                            </div>
                        </div>
                        <div class="addNotes" id="notepad">
                            <paper-input label="Notes" value="{{notes}}">
                                <iron-icon icon="my-icons:speaker-notes" slot="prefix"></iron-icon>
                            </paper-input>
                        </div>
                    </div>
                    <br>
                    <hr>
                    <div class="option" id="option">
                        <paper-checkbox class="close" on-tap="_close" id="close">Close</paper-checkbox>
                        <paper-checkbox class="limited" on-tap="_limited" id="limited">Limited</paper-checkbox>
                        <paper-checkbox class="available" on-tap="_available" id="available">Open</paper-checkbox>
                        <span id="month">
                            <paper-icon-button id="previous" noink on-tap="_preMonth" style="color: black;" icon="my-icons:keyboard-arrow-left"></paper-icon-button>
                            {{month}}
                            <paper-icon-button id="next" noink on-tap="_nextMonth" style="color: black;" icon="my-icons:keyboard-arrow-right"></paper-icon-button>
                        </span>
                    </div>
                    <div id="table">
                        <table id="hotels">
                        </table>
                    </div>
                </div>
            </app-header-layout>
            <paper-fab noink on-tap="_openSave" icon="my-icons:save" class="blue" id="save"></paper-fab>

            <vaadin-dialog id="selectHotelModal" no-close-on-esc no-close-on-outside-click>
                <template>
                    <!-- <h3 style="text-align: center">Added Successfully</h3> -->
                    <hr>
                    <paper-button on-tap="_closeDialog" style="float: right">Ok</paper-button>
                </template>
            </vaadin-dialog>

            <vaadin-dialog id="availabilitySave" no-close-on-esc no-close-on-outside-click>
                <template>
                    <h3 style="text-align: center">Added Successfully</h3>
                    <hr>
                    <paper-button on-tap="_closeDialog" style="float: right">Ok</paper-button>
                </template>
            </vaadin-dialog>
            </div>
        </app-drawer-layout>
        <iron-ajax verbose id="ajax" method="[[method]]" on-response="_handleResponse"></iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'my-availability-new',
            properties: {
                route: Object,
                checked: Boolean,
                mynotes: {
                    type: String,
                    value: '',
                },
                createdBy: {
                    type: String,
                    value: 'Peter Pedro'
                },
                modifiedBy: {
                    type: String,
                    value: 'Ardie Derrayal'
                },
                hotelId: String,
                mot: Number,
                yer: Number,
                days: Number,
                hotelname: String,
                hotelRooms: String,
                prevyear: Number,
                premonth: Number,
                forHotel: Object,
                filterResult: String,
                forAvailability: Object,
                availabilityfilter: String,
                hotelfilter: String,
                data: String,
                hotelObjects: {
                    type: Array,
                    value: [],
                },
                availabilityObject: {
                    type: Array,
                    value: [],
                },
                availabilities: {
                    type: Array,
                    notify: true,
                    value: []
                },
                hotelData: {
                    type: Array,
                    notify: true,
                    value: [],
                },
                type: {
                    type: Array,
                    value: []
                },
            },
            observers: ['_hotelIdChanged(hotelId)',
                '_resultLoaded(forAvailability,forHotel)'],

            _resultLoaded(a, b) {
                var availabilitydata = this.forAvailability;
                var hoteldata = this.forHotel;
                ids = new Set(availabilitydata.map(({ hotel }) => hotel));
                hoteldata = hoteldata.filter(({ hotel }) => !ids.has(hotel));
                this.hotelItems = hoteldata;
            },
            ready() {
                this.url = '/hotel/read';
                this.availabilityurl = '/availability/read';
                var hideTable = Polymer.dom(this.root).querySelector("#table").setAttribute("style", "display:none");
                var hideoption = Polymer.dom(this.root).querySelector("#option").setAttribute("style", "display:none");
                var hidemonth = Polymer.dom(this.root).querySelector("#month").setAttribute("style", "display:none");
                var hidesave = Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:none");
            },
            _hotelLoaded(data) {
                this.forHotel = data.detail.response.data;
            },
            _availabilityLoaded(data) {
                this.forAvailability = data.detail.response.data;
            },
            _handleResponse(data) {
                this.hotelData = data.detail.response.data.room;
                var showTable = Polymer.dom(this.root).querySelector("#table").setAttribute("style", "width:100%;overflow-x:auto;");
                var showoption = Polymer.dom(this.root).querySelector("#option").setAttribute("style", "display:block");
                var showmonth = Polymer.dom(this.root).querySelector("#month").setAttribute("style", "margin-top: 10px; float: right");
                var shownote = Polymer.dom(this.root).querySelector("#notepad").setAttribute("style", "float: right;cursor: pointer;margin-right: -15px;width: 300px;");
                var monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                var currentMonths = new Date()
                this.month = monthNames[currentMonths.getMonth()] + " " + currentMonths.getDate() + " " + currentMonths.getFullYear();
                var date = new Date(currentMonths.getFullYear(), currentMonths.getMonth() + 1, 0).getDate();
                this._nextDates(date, monthNames[currentMonths.getMonth()], currentMonths.getFullYear(), currentMonths.getMonth());
                var months = currentMonths.getMonth();
                var years = currentMonths.getFullYear();
                this.mot = months;
                this.yer = years;
                this.premonth = months;
                this.prevyear = years;
            },

            _hotelIdChanged(e) {
                this.hotelRooms = e;
                this.method = 'GET';
                this.$.ajax.url = '/hotel/filter/' + e;
                this.$.ajax.handleAs = "json";
                this.$.ajax.generateRequest();
            },
            _closeDialog() {
                window.location.assign('/availability');
                this.$.availabilitySave.opened = false;
            },
            _limited() {
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;
                for (var i = 0; i < cells.length; i++) {
                    cells[i].onclick = function (event) {
                        if (event.target.id != "") {
                            this.className = this.className === '' || this.className === "white" ? "yellow" : "white";
                            if (this.className == 'yellow') {
                                var [room, date] = event.target.id.split("_");
                                var classColor = event.target.getAttribute("class");
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: 'limited'
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                            else {
                                var [room, date] = event.target.id.split("_");
                                var classColor = "white";
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: ''
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                        }
                    }
                    var next = Polymer.dom(this.root).querySelector("#next").disabled = true;
                    var showsave = Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                }
            },
            _available() {
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;
                for (var i = 0; i < cells.length; i++) {
                    cells[i].onclick = function (event) {
                        if (event.target.id != "") {
                            this.className = this.className === '' || this.className === "white" ? "green" : "white";
                            if (this.className == 'green') {
                                var [room, date] = event.target.id.split("_");
                                var classColor = event.target.getAttribute("class");
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: 'open'
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                            else {
                                var [room, date] = event.target.id.split("_");
                                var classColor = "white";
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: ''
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                        }
                    }
                    var next = Polymer.dom(this.root).querySelector("#next").disabled = true;
                    var showsave = Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                }
            },
            _close() {
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
                var cells = Polymer.dom(this.root).querySelectorAll("td");
                var _this = this;
                for (var i = 0; i < cells.length; i++) {
                    cells[i].onclick = function (event) {
                        if (event.target.id != "") {
                            this.className = this.className === '' || this.className === "white" ? "red" : "white";
                            if (this.className == 'red') {
                                var [room, date] = event.target.id.split("_");
                                var classColor = event.target.getAttribute("class");
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: 'closed'
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                            else {
                                var [room, date] = event.target.id.split("_");
                                var classColor = "white";
                                var data = {
                                    date: date,
                                    room: room,
                                    classColor: classColor,
                                    status: ''
                                }
                                _this.availabilities.push(data);
                                _this.notifySplices('availabilities');
                            }
                        }
                    }
                    var next = Polymer.dom(this.root).querySelector("#next").disabled = true;
                    var showsave = Polymer.dom(this.root).querySelector("#save").setAttribute("style", "display:position: fixed; bottom: 32px;right: 32px;");
                }
            },
            _preMonth() {
                if (this.mot < 1) {
                    var x = 11;
                    var y = this.yer - 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.yer = y;
                    this.month = m + " " + y;
                    var date = new Date(y, x + 1, 0).getDate();
                    this._nextDates(date, m, y, x)
                } else {
                    var y = this.yer;
                    var x = this.mot - 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.month = m + " " + this.yer;
                    var date = new Date(this.yer, x + 1, 0).getDate();
                    this._nextDates(date, m, this.yer, x)
                }
                this.premonth = this.mot + 1;
                this.prevyear = y;
                // this._saveToDB(true);
                next = Polymer.dom(this.root).querySelector("#next").disabled = false;
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
            },
            _nextMonth() {
                if (this.mot > 10) {
                    var x = 0;
                    var y = this.yer + 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.yer = y;
                    this.month = m + " " + y;
                    var date = new Date(y, x + 1, 0).getDate();
                    this._nextDates(date, m, y, x)
                } else {
                    var y = this.yer;
                    var x = this.mot + 1;
                    var m = this._selectMonth(x);
                    this.mot = x;
                    this.month = m + " " + this.yer;
                    var date = new Date(this.yer, x + 1, 0).getDate();
                    this._nextDates(date, m, this.yer, x)
                }
                // var date = new Date().getFullYear();
                this.prevyear = y;
                this.premonth = this.mot - 1;
                // if (this.prevyear != date) {
                //     this.premonth = 0;
                // }
                console.log(this.premonth + "" + this.prevyear);
                // this._saveToDB(true);
                var close = Polymer.dom(this.root).querySelector("#close").checked = false;
                var limited = Polymer.dom(this.root).querySelector("#limited").checked = false;
                var available = Polymer.dom(this.root).querySelector("#available").checked = false;
            },
            _nextDates(numDays, months, years, daysWeek) {
                var table = Polymer.dom(this.root).querySelector('#hotels');
                while (table.hasChildNodes()) {
                    table.removeChild(table.lastChild);
                }
                //for months date
                var tr1 = document.createElement('tr');
                var th1 = document.createElement('th');
                var t1 = document.createTextNode(months + " " + years);
                th1.append(t1);
                tr1.append(th1);
                table.append(tr1);
                //for weeks name
                var tr2 = document.createElement('tr');
                var th2 = document.createElement('td');
                var t2 = document.createTextNode("Rooms");
                th2.append(t2);
                tr2.append(th2);
                table.append(tr2);

                this.hotelData.forEach(element => {
                    var tr3 = document.createElement('tr');
                    var th3 = document.createElement('td');
                    var datas = element.split(" ").join("");
                    var tdTxt = document.createTextNode(datas);
                    tr3.setAttribute('id', datas);
                    th3.append(tdTxt);
                    tr3.append(th3);
                    table.append(tr3);

                    for (i = 1; i < numDays + 1; ++i) {
                        var tdBlank = document.createElement('td');
                        tdBlank.setAttribute('id', datas + "_" + i);
                        tr3.append(tdBlank);
                    }
                });

                for (i = 1; i < numDays + 1; ++i) {
                    var th = document.createElement('th');
                    var td = document.createTextNode(i);
                    th.append(td);
                    tr1.append(th);
                    //weeks
                    var thweek = document.createElement('td');
                    // thweek.setAttribute("style", "background-color:#c8cace");
                    var date = new Date(years, daysWeek, i)
                    var x = date.getDay();
                    var now = this._selectDays(x);
                    if (now == "Sun") {
                        var tdays = document.createTextNode(now);
                        thweek.setAttribute("style", "color:red;");
                        thweek.append(tdays);
                        tr2.append(thweek);
                    }
                    else {
                        var tdays = document.createTextNode(now);
                        thweek.append(tdays);
                        tr2.append(thweek);
                    }
                }
            },
            _selectMonth(m) {
                var nextmonthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                return nextmonthNames[m];
            },
            _selectDays(d) {
                var weekOfdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                return weekOfdays[d];
            },
            _saveToDB(e) {
                var types = [];
                this.hotelData.forEach(element => {
                    types.push(element);
                });
                var year = this.prevyear;
                var monthly = this.premonth;
                this.method = 'POST';
                this.$.ajax.url = '/availability/add';
                this.$.ajax.contentType = "application/json";
                this.$.ajax.body = {
                    hotel: this.hotelRooms,
                    notes: this.notes,
                    date: monthly + "," + year,
                    month: {
                        month: monthly,
                        yearly: year,
                    },
                    type: types,
                    availabilities: this.availabilities,
                    created_by: this.createdBy,
                    updated_by: this.modifiedBy,
                };
                this.$.ajax.generateRequest();
                this.$.availabilitySave.opened = e;
                this.availabilities = [];
                this.url = '';
            },
            _openSave() {
                this._saveToDB(true)
            },
            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },

        })
    </script>
</dom-module>